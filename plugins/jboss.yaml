# Plugin Info
version: 0.0.4
title: JBoss
description: 'Log parser for JBoss / WildFly.
parameters:
  - name: file_path
    label: JBoss Logs Path
    description: The absolute path to the JBoss logs
    type: string
    default: "/usr/local/JBoss/EAP-*/*/log/server.log"
  - name: start_at
    label: Start At
    description: Start reading file from 'beginning' or 'end'
    type: enum
    valid_values:
      - beginning
      - end
    default: end

# ops agent default file paths
# "/opt/wildfly/standalone/log/server.log"
# "/opt/wildfly/domain/servers/*/log/server.log"
# "/opt/wildfly/domain/log/*.log"

# Set Defaults
# {{$file_path := default "/usr/local/JBoss/EAP-*/*/log/server.log" .file_path}}
# {{$start_at := default "end" .start_at}}

# Pipeline Template
pipeline:
  - id: jboss_input
    type: file_input
    include:
      - {{ $file_path }}
    multiline:
      line_start_pattern: '\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3}'
    start_at: {{ $start_at }}
    labels:
      log_type: jboss
      plugin_id: {{ .id }}
    output: jboss_parser

  - id: jboss_parser
    type: regex_parser
    regex: '^(?P<time>\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2},\d{3})\s+(?P<level>\w+)(?:\s+\[(?P<source>.+?)\])?(?:\s+\((?P<thread>.+?)\))?\s+(?P<message>(?:(?P<messageCode>[\d\w]+):)?[\s\S]*)'
    timestamp:
      parse_from: time
      layout: '%Y-%m-%d %H:%M:%S,%L'
    severity:
      parse_from: level
      mapping:
        emergency: fatal
        warning: warn
    output: {{ .output }}
