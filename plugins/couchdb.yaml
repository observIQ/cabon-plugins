# Plugin Info
version: 0.0.3
title: CouchDB
description: Log parser for CouchDB
parameters:
  - name: file_path
    label: CouchDB Logs Path
    description: The absolute path to the CouchDB logs
    type: string
    default: "/var/log/couchdb/couchdb.log"
  - name: start_at
    label: Start At
    description: Start reading file from 'beginning' or 'end'
    type: enum
    valid_values:
      - beginning
      - end
    default: end

# Set Defaults
# {{$file_path := default "/var/log/couchdb/couchdb.log" .file_path}}
# {{$start_at := default "end" .start_at}}

# Pipeline Template
pipeline:
  - id: couchdb_input
    type: file_input
    include:
      - {{ $file_path }}
    multiline:
      line_start_pattern: ^\[\w+\]
    start_at: {{ $start_at }}
    labels:
      log_type: couchdb
      plugin_id: {{ .id }}
    output: id_router

  # Route based on pid location
  - id: id_router
    type: router
    routes:
      - output: couchdb_access_parser
        expr: $ matches '^\\[(\\w*)\\] ([\\d\\-\\.:TZ]+) (\\S+)@([^\\s]+) \\<([^ ]*)\\> [\\w-]+ ([^ ]*) ([^ ]*) (([^ ]*) ([^ ]*) ([^ ]*) ([^ ]*) ([^ ]*) ([\\d]*))'
      - output: couchdb_parser
        expr: $ matches '^\\[(\\w*)\\] ([\\d\\-\\.:TZ]+) (\\S+)@([^\\s]+) ([\\s\\S]*(\\<([^>]+)\\>)[\\s\\S]*)'

  - id: couchdb_access_parser
    type: regex_parser
    regex: '^\[(?P<level>\w*)\] (?P<timestamp>[\d\-\.:TZ]+) (?P<node>\S+)@(?P<host>[^\s]+) \<(?P<pid>[^ ]*)\> [\w-]+ (?P<http_request_serverIp>[^ ]*) (?P<http_request_remoteIp>[^ ]*) (?P<message>(?P<remote_user>[^ ]*) (?P<http_request_requestMethod>[^ ]*) (?P<path>[^ ]*) (?P<http_request_status>[^ ]*) (?P<status_message>[^ ]*) (?P<http_request_responseSize>[\d]*))'
    timestamp:
      parse_from: timestamp
      layout: '%Y-%m-%dT%H:%M:%S.%sZ'
    severity:
      parse_from: level
      mapping:
        info: notice
        warning: warn
        error: err
        critical: crit
        emergency: emerg
    output: {{.output}}

  - id: couchdb_parser
    type: regex_parser
    regex: '^\[(?P<level>\w*)\] (?P<timestamp>[\d\-\.:TZ]+) (?P<node>\S+)@(?P<host>[^\s]+) (?P<message>[\s\S]*(\<(?P<pid>[^>]+)\>)[\s\S]*)'
    timestamp:
      parse_from: timestamp
      layout: '%Y-%m-%dT%H:%M:%S.%sZ'
    severity:
      parse_from: level
      mapping:
        info: notice
        warning: warn
        error: err
        critical: crit
        emergency: emerg
    output: {{.output}}
