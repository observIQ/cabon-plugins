# Plugin Info
version: 0.0.3
title: Apache Hadoop
description: Log parser for Apache Hadoop
parameters:
  - name: log_paths
    label: Log Path
    description: The absolute path to the data node logs
    type: strings
    default: 
      - "/opt/hadoop/logs/yarn-*.log"
      - "/opt/hadoop/logs/hadoop-*.log"
    relevant_if:
      enable_datanode_logs:
        equals: true
  - name: start_at
    label: Start At
    description: Start reading file from 'beginning' or 'end'
    type: enum
    valid_values:
      - beginning
      - end
    default: end

# Set Defaults
# {{$log_path := default (makeSlice "/opt/hadoop/logs/yarn-*.log" "/opt/hadoop/logs/yarn-*.log") .log_path}}
# {{$start_at := default "end" .start_at}}

# Pipeline Template
pipeline:
  - id: hadoop_namenode_input
    type: file_input
    include:
# {{ range $i, $fp := .log_path  }}
      - '{{ $fp }}'
# {{ end }}
    multiline:
      line_start_pattern: '^\d+-\d+-\d+ \d+:\d+:\d+,\d+.*'
    start_at: {{ $start_at }}
    labels:
      log_type: hadoop.namenode
      plugin_id: {{ .id }}
    output: hadoop_namenode_parser

  - id: hadoop_namenode_parser
    type: regex_parser
    regex: '^(?P<timestamp>\d+-\d+-\d+ \d+:\d+:\d+,\d+)\s+(?P<severity>\w+)\s+(?P<source>\S+):\s+(?P<message>[\S\s]*)'
    timestamp:
      parse_from: timestamp
      layout: '%Y-%m-%d %H:%M:%S,%L'
    severity:
      parse_from: severity
      mapping:
        warning: warn
        critical: fatal
    output: {{.output}}
