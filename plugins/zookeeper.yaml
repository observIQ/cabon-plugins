# Plugin Info
version: 0.0.2
title: Apache Zookeeper
description: Log parser for Apache Zookeeper
parameters:
  - name: file_log_path
    description: The absolute path to the Zookeeper logs
    type: strings
    default: 
    - "/opt/zookeeper/logs/zookeeper-*.out"
    - "/var/log/zookeeper/zookeeper.log"
  - name: start_at
    label: Start At
    description: Start reading file from 'beginning' or 'end'
    type: enum
    valid_values:
      - beginning
      - end
    default: end

# Set Defaults
# {{$start_at := default "end" .start_at}}

# Pipeline Template
pipeline:
  - id: zookeeper_input
    type: file_input
    include:
# {{ range $i, $fp := .file_log_path  }}
      - '{{ $fp }}'
# {{ end }}
    start_at: {{ $start_at }}
    multiline:
      line_start_pattern: '^\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2},\d{3}'
    labels:
      plugin_id: {{ .id }}
    output: id_router

  # Route based on if ID is included
  - id: id_router
    type: router
    default: zookeeper_parser
    routes:
      - output: zookeeper_parser_no_id
        expr: $ matches '^(\\d{4}-\\d{2}-\\d{2}\\s\\d{2}:\\d{2}:\\d{2},\\d{3})\\s-'

  - id: zookeeper_parser
    type: regex_parser
    regex: '^(?P<time>\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2},\d{3})\s\[myid:(?P<myid>\d+)?\]\s-\s(?P<level>\w+)\s+\[(?P<thread>.+):(?P<source>.+)@(?P<line>\d+)\]\s+-\s*(?P<message>[\S\s]*)'
    time:
      parse_from: time
      layout: "%Y-%m-%d %H:%M:%S,%L"
    severity:
      parse_from: level
      mapping:
        warning: warn
        critical: fatal
    output: {{.output}}

  - id: zookeeper_parser_no_id
    type: regex_parser
    regex: '^(?P<time>\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2},\d{3})\s-\s(?P<level>\w+)\s+\[(?P<thread>.+):(?P<source>.+)@(?P<line>\d+)\]\s+-\s*(?P<message>[\S\s]*)'
    time:
      parse_from: time
      layout: "%Y-%m-%d %H:%M:%S,%L"
    severity:
      parse_from: level
      mapping:
        warning: warn
        critical: fatal
    output: {{.output}}
