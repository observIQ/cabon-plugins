version: 1.0.0
title: observIQ Agent
description: Agent logs for the observIQ Agent
parameters:
  - name: start_at
    label: Start At
    description:  Start reading file from 'beginning' or 'end'
    type: enum
    valid_values:
      - beginning
      - end
    default: end
# Set Defaults
# {{$start_at := default "end" .start_at}}
# Pipeline Template
pipeline:
  - id: log_reader
    type: file_input
    include:
      - log/manager.log
      - log/launcher.log
    start_at: {{ $start_at }}
    attributes:
      log_type: observiq.agent
      plugin_id: {{ .id }}

  - id: log_json_parser
    type: json_parser
    severity:
      parse_from: level
      mapping:
        info2: notice
        error2: critical
        error3: alert
        fatal2: emergency
        fatal3: catastrophe
    timestamp:
      parse_from: ts
      layout_type: gotime
      layout: '2006-01-02T15:04:05.000-0700'

  - id: log_type_router
    type: router
    default: log_restructure
    routes:
      - output: log_restructure
        expr: '$attributes.file_name == "manager.log"'
        attributes:
          log_type: observiq.agent.manager
      - output: log_restructure
        expr: '$attributes.file_name == "launcher.log"'
        attributes:
          log_type: observiq.agent.launcher

  - id: log_restructure
    type: restructure
    ops:
      - move:
          from: logger
          to: $attributes.logger
    output: {{ .output }}

  - id: stanza_log
    type: stanza_input

  - type: metadata
    attributes:
      log_type: observiq.agent.logagent
    output: {{ .output }}
